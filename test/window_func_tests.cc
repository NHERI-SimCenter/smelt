#include <catch/catch.hpp>
#include <Eigen/Dense>
#include "function_dispatcher.h"

TEST_CASE("Test window functions", "[WindowFuncs][Helpers]") {

  SECTION("Test Hann window") {
    unsigned int window_length = 23;
    auto hann_window =
        Dispatcher<Eigen::VectorXd, unsigned int>::instance()->dispatch(
            "HannWindow", window_length);

    // This is really is simply function using std::cos function evaluated at
    // different points, so this really only tests the class construction.
    REQUIRE(hann_window[window_length / 2] == Approx(1.0).epsilon(0.01));

    window_length = 101;
    hann_window =
        Dispatcher<Eigen::VectorXd, unsigned int>::instance()->dispatch(
            "HannWindow", window_length);

    std::vector<double> expected_value = {0.0,
                                          0.000986635785864,
                                          0.003942649342761,
                                          0.008856374635656,
                                          0.015708419435684,
                                          0.024471741852423,
                                          0.035111757055874,
                                          0.047586473766990,
                                          0.061846659978068,
                                          0.077836037248992,
                                          0.095491502812526,
                                          0.114743378612105,
                                          0.135515686289294,
                                          0.157726447035656,
                                          0.181288005125655,
                                          0.206107373853763,
                                          0.232086602510502,
                                          0.259123162949142,
                                          0.287110354217464,
                                          0.315937723657661,
                                          0.345491502812526,
                                          0.375655056417573,
                                          0.406309342707138,
                                          0.437333383217848,
                                          0.468604740235343,
                                          0.500000000000000,
                                          0.531395259764657,
                                          0.562666616782152,
                                          0.593690657292862,
                                          0.624344943582427,
                                          0.654508497187474,
                                          0.684062276342339,
                                          0.712889645782536,
                                          0.740876837050858,
                                          0.767913397489498,
                                          0.793892626146236,
                                          0.818711994874345,
                                          0.842273552964344,
                                          0.864484313710706,
                                          0.885256621387895,
                                          0.904508497187474,
                                          0.922163962751007,
                                          0.938153340021932,
                                          0.952413526233010,
                                          0.964888242944126,
                                          0.975528258147577,
                                          0.984291580564316,
                                          0.991143625364344,
                                          0.996057350657239,
                                          0.999013364214136,
                                          1.000000000000000,
                                          0.999013364214136,
                                          0.996057350657239,
                                          0.991143625364344,
                                          0.984291580564316,
                                          0.975528258147577,
                                          0.964888242944126,
                                          0.952413526233010,
                                          0.938153340021932,
                                          0.922163962751007,
                                          0.904508497187474,
                                          0.885256621387895,
                                          0.864484313710706,
                                          0.842273552964344,
                                          0.818711994874345,
                                          0.793892626146236,
                                          0.767913397489498,
                                          0.740876837050858,
                                          0.712889645782536,
                                          0.684062276342339,
                                          0.654508497187474,
                                          0.624344943582427,
                                          0.593690657292862,
                                          0.562666616782152,
                                          0.531395259764657,
                                          0.500000000000000,
                                          0.468604740235343,
                                          0.437333383217848,
                                          0.406309342707138,
                                          0.375655056417573,
                                          0.345491502812526,
                                          0.315937723657661,
                                          0.287110354217464,
                                          0.259123162949142,
                                          0.232086602510502,
                                          0.206107373853763,
                                          0.181288005125655,
                                          0.157726447035656,
                                          0.135515686289294,
                                          0.114743378612105,
                                          0.095491502812526,
                                          0.077836037248992,
                                          0.061846659978068,
                                          0.047586473766990,
                                          0.035111757055874,
                                          0.024471741852423,
                                          0.015708419435684,
                                          0.008856374635656,
                                          0.003942649342761,
                                          0.000986635785864,
                                          0.0};

    REQUIRE(hann_window.size() == expected_value.size());

    for (unsigned int i = 0; i < hann_window.size(); ++i) {
      REQUIRE(std::abs(hann_window[i] - expected_value[i]) < 1E-6);
    }
  }
}
